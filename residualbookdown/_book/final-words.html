<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>A Minimal Book Example</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="A Minimal Book Example">
  <meta name="generator" content="bookdown 0.0.71 and GitBook 2.6.7">

  <meta property="og:title" content="A Minimal Book Example" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="A Minimal Book Example" />
  
  
  

<meta name="author" content="Yihui Xie">

<meta name="date" content="2016-07-12">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="comparing-with-the-old-code.html">


<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="description-of-simulation-framework.html"><a href="description-of-simulation-framework.html"><i class="fa fa-check"></i><b>3</b> Description of Simulation Framework</a></li>
<li class="chapter" data-level="4" data-path="testing-simulations.html"><a href="testing-simulations.html"><i class="fa fa-check"></i><b>4</b> Testing Simulations</a></li>
<li class="chapter" data-level="5" data-path="comparing-with-the-old-code.html"><a href="comparing-with-the-old-code.html"><i class="fa fa-check"></i><b>5</b> Comparing with the old code</a></li>
<li class="chapter" data-level="6" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>6</b> Final Words</a><ul>
<li class="chapter" data-level="6.1" data-path="final-words.html"><a href="final-words.html#testing-under-et-model"><i class="fa fa-check"></i><b>6.1</b> Testing Under ET Model</a></li>
<li class="chapter" data-level="6.2" data-path="final-words.html"><a href="final-words.html#posteriors-with-et"><i class="fa fa-check"></i><b>6.2</b> Posteriors With ET</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://www.rstudio.com" target="blank">Published with RStudio Press</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A Minimal Book Example</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="final-words" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Final Words</h1>
<p>We have finished a nice book.</p>

<div id="testing-under-et-model" class="section level2">
<h2><span class="header-section-number">6.1</span> Testing Under ET Model</h2>
<p>Great!! Now let’s make sure this is true with the ET model.Recall that in the ET model:</p>
<p><span class="math">\[\frac{\beta}{\hat{s}} \sim N(0,Uk)\]</span> Thus the input summary statistic is <span class="math">\(t_j \sim N(0,V_j)\)</span> where <span class="math">\(t_{jr}\)</span> has standard error of 1.</p>
<p>First, we repeat the checks between the old and new code check to see they give the same result when the residuals are assumed to be uncorrelated (i.e., var mat is the Identity matrix)</p>
<pre class="sourceCode r"><code class="sourceCode r">##Here i just rescale the covariance matrices to be consistent with the fact that the true Z&#39;s are on order $1/standard error$ larger.
covmat=<span class="kw">lapply</span>(s$component.mats,function(x){
  <span class="co">#median(abs(s$t.stat))^2*</span>
  (<span class="dv">1</span>/<span class="fl">0.11</span>)^<span class="dv">2</span>*x})
<span class="kw">compute.hm.train.log.lik.pen.vmat</span>(<span class="dt">train.b =</span> s$t.stat[<span class="dv">1</span>:<span class="dv">1000</span>,],<span class="dt">covmat=</span>covmat,<span class="dt">A =</span> <span class="st">&quot;testwithtdiag&quot;</span>,<span class="dt">pen =</span> <span class="dv">1</span>,<span class="dt">vmat =</span> <span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">44</span>))</code></pre>
<pre><code>## quartz_off_screen 
##                 2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">lik.mat=<span class="kw">readRDS</span>(<span class="st">&quot;liketraintestwithtdiag.rds&quot;</span>)
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistestwithtdiag.rds&quot;</span>)$pihat
test=<span class="kw">exp</span>(lik.mat)
<span class="kw">total.lik.func</span>(test,pis)</code></pre>
<pre><code>## [1] -53511.16</code></pre>
<p>And now we repeat with the old code which required a <span class="math">\(JxR\)</span> matrix of standard erros, so we need repeat</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compute.hm.train.log.lik.pen</span>(<span class="dt">train.b =</span> s$t.stat[<span class="dv">1</span>:<span class="dv">1000</span>,],<span class="dt">se.train =</span> s$sebetahat/s$sebetahat,<span class="dt">covmat =</span> covmat,<span class="dt">A=</span><span class="st">&quot;t.testwitholdcode&quot;</span>,<span class="dt">pen=</span><span class="dv">1</span>)</code></pre>
<pre><code>## quartz_off_screen 
##                 2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">lik.mat=<span class="kw">readRDS</span>(<span class="st">&quot;liketraint.testwitholdcode.rds&quot;</span>)
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pist.testwitholdcode.rds&quot;</span>)$pihat
test=<span class="kw">exp</span>(lik.mat)
<span class="kw">total.lik.func</span>(test,pis)</code></pre>
<pre><code>## [1] -53511.16</code></pre>
<p>Good! And let’s make sure the likelihood with the real vmat is better under the ET assumption. Recall that here, we can use <code>cov2cor</code> of the var mat so that the diagonals are 1 and every off diagonal element is divided by the <span class="math">\(sj_i,sj_r\)</span></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">compute.hm.train.log.lik.pen.vmat</span>(<span class="dt">train.b =</span> s$t.stat[<span class="dv">1</span>:<span class="dv">1000</span>,],<span class="dt">covmat=</span>covmat,<span class="dt">A =</span> <span class="st">&quot;test.tcov2cor&quot;</span>,<span class="dt">pen =</span> <span class="dv">1</span>,<span class="dt">vmat =</span> <span class="kw">cov2cor</span>(s$var.mat))</code></pre>
<pre><code>## quartz_off_screen 
##                 2</code></pre>
<p>Just to validate using the vmat as the <code>cov2cor</code> of the true var.mat, let’s look at the actual empirical covariance of the null t statistics values:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cov</span>(s$t.stat[<span class="dv">401</span>:<span class="dv">1000</span>,])[<span class="dv">1</span>:<span class="dv">5</span>,<span class="dv">1</span>:<span class="dv">5</span>]</code></pre>
<pre><code>##           V1        V2        V3        V4        V5
## V1 0.9311665 0.7235246 0.7290662 0.7504313 0.7155237
## V2 0.7235246 0.8954124 0.7043773 0.7221044 0.6903662
## V3 0.7290662 0.7043773 0.9243214 0.7371314 0.7022638
## V4 0.7504313 0.7221044 0.7371314 0.9673997 0.7146324
## V5 0.7155237 0.6903662 0.7022638 0.7146324 0.8663204</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cov2cor</span>(s$var.mat)[<span class="dv">1</span>:<span class="dv">5</span>,<span class="dv">1</span>:<span class="dv">5</span>]</code></pre>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]  1.0  0.8  0.8  0.8  0.8
## [2,]  0.8  1.0  0.8  0.8  0.8
## [3,]  0.8  0.8  1.0  0.8  0.8
## [4,]  0.8  0.8  0.8  1.0  0.8
## [5,]  0.8  0.8  0.8  0.8  1.0</code></pre>
<p>And here we go. You’ll note that <strong>the likelihood in this case, where the residuals are highly structured, is much improved</strong>!! Great!!!</p>
<pre class="sourceCode r"><code class="sourceCode r">lik.mat=<span class="kw">readRDS</span>(<span class="st">&quot;liketraintest.tcov2cor.rds&quot;</span>)
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistest.tcov2cor.rds&quot;</span>)$pihat
test=<span class="kw">exp</span>(lik.mat)
<span class="kw">total.lik.func</span>(test,pis)</code></pre>
<pre><code>## [1] -36472.73</code></pre>

<p><strong>Posterior Tests</strong></p>
<p>Now, let’s also test our ability to compute posteriors under both methods. Again, let’s use but EE and ET, first try with diagonalised standard errors to show that the results match our previous computations.</p>
<pre class="sourceCode r"><code class="sourceCode r">j=<span class="kw">sample</span>(<span class="dv">100</span>,<span class="dv">1</span>)
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistestwitholdcode.rds&quot;</span>)
b.with.old.code=<span class="kw">total.quant.per.snp</span>(<span class="dt">j =</span> j,<span class="dt">covmat =</span> s$component.mats,<span class="dt">b.gp.hat =</span> s$betahat,<span class="dt">se.gp.hat =</span> s$sebetahat,<span class="dt">pis =</span> pis$pihat,<span class="dt">checkpoint =</span> T)

##and here was where I used the new code (i.e. with vmat), with the squared standard error on the diagonal. 

pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistesteewithdiagvmat.rds&quot;</span>)
b.with.new.code=<span class="kw">total.quant.per.snp.with.vmat</span>(<span class="dt">j =</span> j,<span class="dt">covmat =</span> s$component.mats,<span class="dt">b.gp.hat =</span> s$betahat,<span class="dt">var.mat =</span> <span class="kw">diag</span>(<span class="kw">diag</span>(s$sebetahat^<span class="dv">2</span>)),<span class="dt">pis =</span> pis$pihat,<span class="dt">checkpoint =</span> T)

<span class="kw">rbind</span>(b.with.new.code$posterior.means,b.with.old.code$posterior.means)</code></pre>
<pre><code>##           [,1]      [,2]      [,3]      [,4]      [,5]     [,6]       [,7]
## [1,] 0.2015357 0.1483815 0.0746145 0.1589729 0.1128013 0.178949 -0.1012554
## [2,] 0.2015357 0.1483815 0.0746145 0.1589729 0.1128013 0.178949 -0.1012554
##            [,8]       [,9]      [,10]      [,11]      [,12]       [,13]
## [1,] -0.1142208 -0.1012226 -0.0982012 -0.1157122 -0.1238635 -0.07876207
## [2,] -0.1142208 -0.1012226 -0.0982012 -0.1157122 -0.1238635 -0.07876207
##            [,14]      [,15]       [,16]     [,17]      [,18]      [,19]
## [1,] -0.07819967 -0.1146526 -0.09919273 0.1289659 0.08317053 0.07451512
## [2,] -0.07819967 -0.1146526 -0.09919273 0.1289659 0.08317053 0.07451512
##           [,20]     [,21]     [,22]      [,23]     [,24]      [,25]
## [1,] 0.08833867 0.1273516 0.1021804 0.07117179 0.1455498 0.06213119
## [2,] 0.08833867 0.1273516 0.1021804 0.07117179 0.1455498 0.06213119
##           [,26]      [,27]    [,28]        [,29]     [,30]      [,31]
## [1,] 0.05349847 0.05732494 0.235553 -0.002808655 0.1685246 0.06964702
## [2,] 0.05349847 0.05732494 0.235553 -0.002808655 0.1685246 0.06964702
##          [,32]      [,33]      [,34]     [,35]      [,36]     [,37]
## [1,] 0.1021515 0.01624453 0.06777181 0.0568386 0.06029456 0.1002719
## [2,] 0.1021515 0.01624453 0.06777181 0.0568386 0.06029456 0.1002719
##          [,38]     [,39]      [,40]     [,41]      [,42]      [,43]
## [1,] 0.1767244 0.1137695 -0.0067579 0.1817134 0.06913085 0.05501313
## [2,] 0.1767244 0.1137695 -0.0067579 0.1817134 0.06913085 0.05501313
##          [,44]
## [1,] 0.5025378
## [2,] 0.5025378</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rbind</span>(b.with.new.code$lfsr,b.with.old.code$lfsr)</code></pre>
<pre><code>##              [,1]         [,2]         [,3]         [,4]         [,5]
## [1,] 1.777467e-13 4.019007e-14 4.629175e-11 8.267163e-10 1.021477e-10
## [2,] 1.778577e-13 4.030110e-14 4.629186e-11 8.267164e-10 1.021478e-10
##              [,6]         [,7]         [,8]         [,9]        [,10]
## [1,] 1.421126e-08 5.101713e-06 8.784653e-06 2.445589e-05 3.996607e-05
## [2,] 1.421126e-08 5.101713e-06 8.784653e-06 2.445589e-05 3.996607e-05
##             [,11]        [,12]        [,13]        [,14]        [,15]
## [1,] 8.066687e-06 3.485455e-06 1.751646e-05 1.540247e-05 5.488705e-06
## [2,] 8.066687e-06 3.485455e-06 1.751646e-05 1.540247e-05 5.488705e-06
##           [,16]        [,17]        [,18]        [,19]        [,20]
## [1,] 7.5505e-06 4.908296e-13 6.422345e-07 6.119513e-05 1.601397e-09
## [2,] 7.5505e-06 4.909406e-13 6.422345e-07 6.119513e-05 1.601397e-09
##             [,21]        [,22]        [,23]        [,24]        [,25]
## [1,] 2.442491e-14 1.595424e-09 6.909691e-05 3.825839e-09 1.427649e-07
## [2,] 2.453593e-14 1.595424e-09 6.909691e-05 3.825839e-09 1.427649e-07
##             [,26]        [,27]        [,28]        [,29]        [,30]
## [1,] 5.680655e-07 1.055955e-10 3.630429e-14 0.0006555118 1.492993e-09
## [2,] 5.680655e-07 1.055956e-10 3.641532e-14 0.0006555118 1.492993e-09
##             [,31]        [,32]        [,33]        [,34]        [,35]
## [1,] 4.363539e-09 4.239942e-13 9.004036e-05 4.288192e-11 5.699246e-05
## [2,] 4.363539e-09 4.241052e-13 9.004036e-05 4.288203e-11 5.699246e-05
##             [,36]        [,37]       [,38]        [,39]        [,40]
## [1,] 0.0001075988 1.687539e-14 3.83360e-13 6.195044e-14 0.0003229651
## [2,] 0.0001075988 1.698641e-14 3.83471e-13 6.206147e-14 0.0003229651
##             [,41]        [,42]        [,43]        [,44]
## [1,] 6.682632e-11 1.023028e-09 3.981323e-10 4.746182e-10
## [2,] 6.682643e-11 1.023029e-09 3.981324e-10 4.746183e-10</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">##and let&#39;s do the same thing for the t stat

j=<span class="kw">sample</span>(<span class="dv">100</span>,<span class="dv">1</span>)
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pist.testwitholdcode.rds&quot;</span>)
t.with.old.code=<span class="kw">total.quant.per.snp</span>(<span class="dt">j =</span> j,<span class="dt">covmat =</span> covmat,<span class="dt">b.gp.hat =</span> s$t.stat,<span class="dt">se.gp.hat =</span> s$sebetahat/s$sebetahat,<span class="dt">pis =</span> pis$pihat,<span class="dt">checkpoint =</span> T)

##and here was where I used the new code (i.e. with vmat), with the squared standard error on the diagonal. Let&#39;s use the same pis just so that we&#39;re testing the posterior code and not the HM, which might have slightly different weights (but the total likelihood was the same)

pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistestwithtdiag.rds&quot;</span>)
t.with.new.code=<span class="kw">total.quant.per.snp.with.vmat</span>(<span class="dt">j =</span> j,<span class="dt">covmat =</span> covmat,<span class="dt">b.gp.hat =</span> s$t.stat,<span class="dt">var.mat =</span> <span class="kw">diag</span>(<span class="dv">1</span>,<span class="dv">44</span>),<span class="dt">pis =</span> pis$pihat,<span class="dt">checkpoint =</span> T)

<span class="kw">rbind</span>(t.with.new.code$posterior.means,t.with.old.code$posterior.means)</code></pre>
<pre><code>##          [,1]     [,2]     [,3]     [,4]     [,5]     [,6]     [,7]
## [1,] 24.43584 17.20741 12.81251 20.67968 14.06292 25.27323 7.589553
## [2,] 24.43584 17.20741 12.81251 20.67968 14.06292 25.27323 7.589553
##          [,8]     [,9]    [,10]    [,11]   [,12]    [,13]  [,14]    [,15]
## [1,] 9.841762 9.850467 11.34124 9.825364 8.82721 7.931264 8.0972 9.072362
## [2,] 9.841762 9.850467 11.34124 9.825364 8.82721 7.931264 8.0972 9.072362
##         [,16]    [,17]    [,18]    [,19]    [,20]    [,21]    [,22]
## [1,] 8.480551 17.50992 8.594155 19.36681 14.71005 15.98254 15.32113
## [2,] 8.480551 17.50992 8.594155 19.36681 14.71005 15.98254 15.32113
##         [,23]    [,24]    [,25]    [,26]    [,27]    [,28]    [,29]
## [1,] 16.28779 22.51058 15.07915 15.21326 8.417744 20.94597 18.09774
## [2,] 16.28779 22.51058 15.07915 15.21326 8.417744 20.94597 18.09774
##         [,30]    [,31]    [,32]    [,33]    [,34]    [,35]    [,36]
## [1,] 25.91101 11.30769 14.07423 10.65925 10.72332 14.83631 18.99049
## [2,] 25.91101 11.30769 14.07423 10.65925 10.72332 14.83631 18.99049
##         [,37]    [,38]  [,39]    [,40]    [,41]    [,42]    [,43]    [,44]
## [1,] 9.661218 11.07759 15.266 4.668178 24.44532 10.20505 9.342254 11.94294
## [2,] 9.661218 11.07759 15.266 4.668178 24.44532 10.20505 9.342254 11.94294</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rbind</span>(t.with.new.code$lfsr,t.with.old.code$lfsr)</code></pre>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13]
## [1,]    0    0    0    0    0    0    0    0    0     0     0     0     0
## [2,]    0    0    0    0    0    0    0    0    0     0     0     0     0
##      [,14] [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24]
## [1,]     0     0     0     0     0     0     0     0     0     0     0
## [2,]     0     0     0     0     0     0     0     0     0     0     0
##      [,25] [,26] [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35]
## [1,]     0     0     0     0     0     0     0     0     0     0     0
## [2,]     0     0     0     0     0     0     0     0     0     0     0
##      [,36] [,37] [,38] [,39]        [,40] [,41] [,42] [,43] [,44]
## [1,]     0     0     0     0 1.060667e-06     0     0     0     0
## [2,]     0     0     0     0 1.060667e-06     0     0     0     0</code></pre>
<p>And now, let’s make sure the RMSE is better. We’ll use the EE:</p>
<pre class="sourceCode r"><code class="sourceCode r">covmat=s$component.mats
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistestwitholdcode.rds&quot;</span>)$pihat
weightedquants=<span class="kw">lapply</span>(<span class="kw">seq</span>(<span class="dv">1</span>:<span class="kw">nrow</span>(s$betahat)),function(j){<span class="kw">total.quant.per.snp</span>(j,covmat,<span class="dt">b.gp.hat=</span>s$betahat,<span class="dt">se.gp.hat =</span> s$sebetahat,pis,<span class="dt">A=</span><span class="st">&quot;testwitholdcode&quot;</span>,<span class="dt">checkpoint =</span> <span class="ot">FALSE</span>)})

##check to make sure results same

pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistesteewithdiagvmat.rds&quot;</span>)$pihat
weightedquants=<span class="kw">lapply</span>(<span class="kw">seq</span>(<span class="dv">1</span>:<span class="kw">nrow</span>(s$betahat)),function(j){<span class="kw">total.quant.per.snp</span>(j,covmat,<span class="dt">b.gp.hat=</span>s$betahat,<span class="dt">se.gp.hat =</span> s$sebetahat,pis,<span class="dt">A=</span><span class="st">&quot;eewithdiagvmat&quot;</span>,<span class="dt">checkpoint =</span> <span class="ot">FALSE</span>)})

pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistestwithrealvmat.rds&quot;</span>)$pihat
weightedquants=<span class="kw">lapply</span>(<span class="kw">seq</span>(<span class="dv">1</span>:<span class="kw">nrow</span>(s$betahat)),function(j){<span class="kw">total.quant.per.snp.with.vmat</span>(j,covmat,<span class="dt">b.gp.hat=</span>s$betahat,<span class="dt">var.mat =</span> s$var.mat,pis,<span class="dt">A=</span><span class="st">&quot;testwithrealvmat&quot;</span>,<span class="dt">checkpoint =</span> <span class="ot">FALSE</span>)})

post.means.var.mat=<span class="kw">as.matrix</span>(<span class="kw">read.table</span>(<span class="st">&quot;testwithrealvmatposterior.means.txt&quot;</span>)[,-<span class="dv">1</span>])
post.means.diag.mat=<span class="kw">as.matrix</span>(<span class="kw">read.table</span>(<span class="st">&quot;eewithdiagvmatposterior.means.txt&quot;</span>)[,-<span class="dv">1</span>])
beta=<span class="kw">as.matrix</span>(s$beta)</code></pre>
<p>And the RMSE is so much better!!!</p>
<pre class="sourceCode r"><code class="sourceCode r">rmse.table=<span class="kw">data.frame</span>(<span class="st">&quot;withresidualmat&quot;</span>=<span class="kw">sqrt</span>(<span class="kw">mean</span>((beta[<span class="dv">1</span>:<span class="dv">1000</span>,]-post.means.var.mat[<span class="dv">1</span>:<span class="dv">1000</span>,])^<span class="dv">2</span>)),<span class="st">&quot;diagresiduals&quot;</span>=<span class="kw">sqrt</span>(<span class="kw">mean</span>((beta[<span class="dv">1</span>:<span class="dv">1000</span>,]-post.means.diag.mat[<span class="dv">1</span>:<span class="dv">1000</span>,])^<span class="dv">2</span>)))
<span class="kw">barplot</span>(<span class="kw">as.matrix</span>(rmse.table),<span class="dt">names=</span><span class="kw">colnames</span>(rmse.table))</code></pre>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>As are the ROC curces:</p>
<pre class="sourceCode r"><code class="sourceCode r">lfsr.diag.mat=<span class="kw">read.table</span>(<span class="st">&quot;testwitholdcodelfsr.txt&quot;</span>)[,-<span class="dv">1</span>]
lfsr.var.mat=<span class="kw">read.table</span>(<span class="st">&quot;testwithrealvmatlfsr.txt&quot;</span>)[,-<span class="dv">1</span>]

thresh=<span class="kw">seq</span>(<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dt">by=</span><span class="fl">0.01</span>)
fp.var.mat=<span class="ot">NULL</span>
fp.diag.mat=<span class="ot">NULL</span>
tp.var.mat=<span class="ot">NULL</span>
tp.diag.mat=<span class="ot">NULL</span>
for(t in <span class="dv">1</span>:<span class="kw">length</span>(thresh)){
  sig=thresh[t]
  fp.var.mat[t]=<span class="kw">mean</span>(beta==<span class="dv">0</span>&amp;lfsr.var.mat&lt;sig)
  fp.diag.mat[t]=<span class="kw">mean</span>(beta==<span class="dv">0</span>&amp;lfsr.diag.mat&lt;sig)
  tp.var.mat[t]=<span class="kw">mean</span>(beta!=<span class="dv">0</span>&amp;lfsr.var.mat&lt;sig)
  tp.diag.mat[t]=<span class="kw">mean</span>(beta!=<span class="dv">0</span>&amp;lfsr.diag.mat&lt;sig)
}

<span class="kw">plot</span>(fp.var.mat,tp.var.mat,<span class="dt">type=</span><span class="st">&quot;l&quot;</span>,<span class="dt">col=</span><span class="st">&quot;green&quot;</span>)
<span class="kw">lines</span>(fp.diag.mat,tp.diag.mat,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</code></pre>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>

</div>
<div id="posteriors-with-et" class="section level2">
<h2><span class="header-section-number">6.2</span> Posteriors With ET</h2>
<p>And now, let’s make sure the RMSE is better. We’ll use the ET now:</p>
<pre class="sourceCode r"><code class="sourceCode r">covmat=<span class="kw">lapply</span>(s$component.mats,function(x){
  <span class="co">#median(abs(s$t.stat))^2*</span>
  (<span class="dv">1</span>/<span class="fl">0.11</span>)^<span class="dv">2</span>*x})
pis=<span class="kw">readRDS</span>(<span class="st">&quot;pist.testwitholdcode.rds&quot;</span>)$pihat
weightedquants=<span class="kw">lapply</span>(<span class="kw">seq</span>(<span class="dv">1</span>:<span class="kw">nrow</span>(s$betahat)),function(j){<span class="kw">total.quant.per.snp</span>(j,covmat,<span class="dt">b.gp.hat=</span>s$t.stat,<span class="dt">se.gp.hat =</span> s$sebetahat/s$sebetahat,pis,<span class="dt">A=</span><span class="st">&quot;EToldcode&quot;</span>,<span class="dt">checkpoint =</span> <span class="ot">FALSE</span>)})


pis=<span class="kw">readRDS</span>(<span class="st">&quot;pistest.tcov2cor.rds&quot;</span>)$pihat
weightedquants=<span class="kw">lapply</span>(<span class="kw">seq</span>(<span class="dv">1</span>:<span class="kw">nrow</span>(s$betahat)),function(j){<span class="kw">total.quant.per.snp.with.vmat</span>(j,covmat,<span class="dt">b.gp.hat=</span>s$t.stat,<span class="dt">var.mat =</span> <span class="kw">cov2cor</span>(s$var.mat),pis,<span class="dt">A=</span><span class="st">&quot;ETwithrealvmat&quot;</span>,<span class="dt">checkpoint =</span> <span class="ot">FALSE</span>)})

post.means.var.mat=<span class="kw">as.matrix</span>(<span class="kw">read.table</span>(<span class="st">&quot;ETwithrealvmatposterior.means.txt&quot;</span>)[,-<span class="dv">1</span>])*<span class="kw">as.matrix</span>(s$sebetahat)
post.means.diag.mat=<span class="kw">as.matrix</span>(<span class="kw">read.table</span>(<span class="st">&quot;EToldcodeposterior.means.txt&quot;</span>)[,-<span class="dv">1</span>])*<span class="kw">as.matrix</span>(s$sebetahat)
beta=<span class="kw">as.matrix</span>(s$beta)</code></pre>
<p>And the RMSE is so much better!!!</p>
<pre class="sourceCode r"><code class="sourceCode r">rmse.table=<span class="kw">data.frame</span>(<span class="st">&quot;withresidualmat&quot;</span>=<span class="kw">sqrt</span>(<span class="kw">mean</span>((beta[<span class="dv">1</span>:<span class="dv">1000</span>,]-post.means.var.mat[<span class="dv">1</span>:<span class="dv">1000</span>,])^<span class="dv">2</span>)),<span class="st">&quot;diagresiduals&quot;</span>=<span class="kw">sqrt</span>(<span class="kw">mean</span>((beta[<span class="dv">1</span>:<span class="dv">1000</span>,]-post.means.diag.mat[<span class="dv">1</span>:<span class="dv">1000</span>,])^<span class="dv">2</span>)))
<span class="kw">barplot</span>(<span class="kw">as.matrix</span>(rmse.table),<span class="dt">names=</span><span class="kw">colnames</span>(rmse.table))</code></pre>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>As are the ROC curces:</p>
<pre class="sourceCode r"><code class="sourceCode r">lfsr.var.mat=<span class="kw">read.table</span>(<span class="st">&quot;ETwithrealvmatlfsr.txt&quot;</span>)[,-<span class="dv">1</span>]
lfsr.diag.mat=<span class="kw">read.table</span>(<span class="st">&quot;EToldcodelfsr.txt&quot;</span>)[,-<span class="dv">1</span>]

thresh=<span class="kw">seq</span>(<span class="dv">0</span>,<span class="fl">0.5</span>,<span class="dt">by=</span><span class="fl">0.01</span>)
fp.var.mat=<span class="ot">NULL</span>
fp.diag.mat=<span class="ot">NULL</span>
tp.var.mat=<span class="ot">NULL</span>
tp.diag.mat=<span class="ot">NULL</span>
for(t in <span class="dv">1</span>:<span class="kw">length</span>(thresh)){
  sig=thresh[t]
  fp.var.mat[t]=<span class="kw">mean</span>(beta==<span class="dv">0</span>&amp;lfsr.var.mat&lt;sig)
  fp.diag.mat[t]=<span class="kw">mean</span>(beta==<span class="dv">0</span>&amp;lfsr.diag.mat&lt;sig)
  tp.var.mat[t]=<span class="kw">mean</span>(beta!=<span class="dv">0</span>&amp;lfsr.var.mat&lt;sig)
  tp.diag.mat[t]=<span class="kw">mean</span>(beta!=<span class="dv">0</span>&amp;lfsr.diag.mat&lt;sig)
}

<span class="kw">plot</span>(fp.var.mat,tp.var.mat,<span class="dt">type=</span><span class="st">&quot;l&quot;</span>,<span class="dt">col=</span><span class="st">&quot;green&quot;</span>)
<span class="kw">lines</span>(fp.diag.mat,tp.diag.mat,<span class="dt">col=</span><span class="st">&quot;red&quot;</span>)</code></pre>
<p><img src="bookdown-demo_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>

<div class="references">

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="comparing-with-the-old-code.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>


<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/inst/examples/05-summary.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
